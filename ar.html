<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>AR - WebWay</title>
  
  <!-- Librer√≠as AR con versiones espec√≠ficas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  
  <link rel="stylesheet" href="styles/styles.css">
  <style>
    /* Reset completo para AR */
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      width: 100vw;
      height: 100vh;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-family: Arial, sans-serif;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #333;
      border-top: 5px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .camera-permission {
      text-align: center;
      padding: 20px;
      max-width: 300px;
    }
    
    .permission-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
    
    /* Asegurar que la escena ocupe toda la pantalla */
    a-scene {
      width: 100vw !important;
      height: 100vh !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      z-index: 1 !important;
    }
  </style>
</head>
<body>
  <!-- Overlay de permisos -->
  <div id="permission-overlay" class="loading" style="display: none;">
    <div class="camera-permission">
      <h2>Permiso de C√°mara Requerido</h2>
      <p>Esta app necesita acceso a tu c√°mara para la realidad aumentada.</p>
      <button id="start-camera-btn" class="permission-btn">Activar C√°mara</button>
      <p id="camera-error" style="color: #ff6b6b; margin-top: 1rem; display: none;"></p>
    </div>
  </div>

  <!-- Loading inicial -->
  <div id="initial-loading" class="loading">
    <div class="spinner"></div>
    <p>Preparando realidad aumentada...</p>
  </div>

  <!-- Escena AR -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; matrixCodeType: 3x3;"
    renderer="logarithmicDepthBuffer: true; antialias: true;"
    gesture-detector
    id="ar-scene"
    style="display: none;"
  >
    <a-assets>
      <a-asset-item id="arrowAsset" src=""></a-asset-item>
    </a-assets>
    
    <a-camera 
      gps-camera 
      rotation-reader 
      look-controls="enabled: true"
      wasd-controls="enabled: false"
    ></a-camera>
    
    <!-- Flecha de navegaci√≥n -->
    <a-entity 
      id="arrow"
      geometry="primitive: cone; height: 4; radiusBottom: 1"
      material="color: #FF3366; metalness: 0.5; roughness: 0.5"
      scale="3 3 3"
      visible="false"
      gps-entity-place="latitude: 0; longitude: 0"
    ></a-entity>
  </a-scene>

  <!-- Panel de control -->
  <div class="ar-controls">
    <div id="info" class="info-panel">
      <h3>Navegaci√≥n AR</h3>
      <p>Inicializando...</p>
    </div>
    <button id="back-btn" class="btn btn-secondary" onclick="window.location.href='index.html'">
      ‚Üê Volver
    </button>
  </div>

  <script>
    // Manejo de permisos de c√°mara
    class CameraManager {
      constructor() {
        this.hasPermission = false;
        this.init();
      }

      async init() {
        try {
          // Verificar si la API de medios est√° disponible
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Tu navegador no soporta acceso a la c√°mara');
          }

          // Intentar obtener permisos autom√°ticamente
          await this.requestCameraPermission();
          
        } catch (error) {
          console.error('Error inicializando c√°mara:', error);
          this.showPermissionOverlay(error.message);
        }
      }

      async requestCameraPermission() {
        try {
          console.log('Solicitando permisos de c√°mara...');
          
          // Intentar acceder a la c√°mara
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: {
              facingMode: 'environment', // Preferir c√°mara trasera
              width: { ideal: 1280 },
              height: { ideal: 720 }
            },
            audio: false
          });
          
          // Parar el stream inmediatamente (AR.js lo manejar√°)
          stream.getTracks().forEach(track => track.stop());
          
          this.hasPermission = true;
          console.log('‚úÖ Permisos de c√°mara concedidos');
          this.hidePermissionOverlay();
          this.startARScene();
          
        } catch (error) {
          console.error('‚ùå Error de c√°mara:', error);
          this.showPermissionOverlay(this.getErrorMessage(error));
        }
      }

      getErrorMessage(error) {
        switch(error.name) {
          case 'NotAllowedError':
            return 'Permiso de c√°mara denegado. Por favor, permite el acceso a la c√°mara en la configuraci√≥n de tu navegador.';
          case 'NotFoundError':
            return 'No se encontr√≥ ninguna c√°mara disponible.';
          case 'NotSupportedError':
            return 'Tu navegador no soporta realidad aumentada.';
          case 'NotReadableError':
            return 'La c√°mara est√° siendo usada por otra aplicaci√≥n.';
          default:
            return `Error de c√°mara: ${error.message}`;
        }
      }

      showPermissionOverlay(message) {
        document.getElementById('initial-loading').style.display = 'none';
        const overlay = document.getElementById('permission-overlay');
        const errorElem = document.getElementById('camera-error');
        
        errorElem.textContent = message;
        errorElem.style.display = 'block';
        overlay.style.display = 'flex';
      }

      hidePermissionOverlay() {
        document.getElementById('permission-overlay').style.display = 'none';
      }

      startARScene() {
        const scene = document.getElementById('ar-scene');
        if (scene) {
          scene.style.display = 'block';
          document.getElementById('initial-loading').style.display = 'none';
          console.log('üöÄ Escena AR iniciada');
        }
      }
    }

    // Inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', () => {
      window.cameraManager = new CameraManager();
      
      // Configurar bot√≥n de permisos
      document.getElementById('start-camera-btn').addEventListener('click', () => {
        window.cameraManager.requestCameraPermission();
      });
    });
  </script>
  
  <script src="scripts/ar-navigation.js"></script>
</body>
</html>