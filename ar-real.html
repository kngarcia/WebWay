<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>AR Real - WebWay</title>
  
  <!-- Three.js para 3D real -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- Controls para dispositivos m√≥viles -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/DeviceOrientationControls.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
    }
    
    #camera-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
    }
    
    #camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #threejs-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 2;
      pointer-events: none;
    }
    
    canvas {
      display: block;
    }
    
    .info-panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 15px;
      z-index: 3;
      max-width: 90%;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .btn {
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      margin: 8px 5px;
      cursor: pointer;
      font-size: 16px;
      pointer-events: auto;
    }
    
    .btn-secondary {
      background: #666;
    }
    
    .debug-info {
      font-size: 12px;
      color: #ccc;
      margin-top: 10px;
      line-height: 1.4;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #333;
      border-top: 5px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .permission-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      padding: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Video de la c√°mara -->
  <div id="camera-container">
    <video id="camera-video" autoplay playsinline></video>
  </div>

  <!-- Canvas de Three.js donde se dibuja la flecha 3D -->
  <div id="threejs-container"></div>

  <!-- Panel de informaci√≥n -->
  <div id="info" class="info-panel">
    <h3 style="margin: 0 0 10px 0;">üß≠ AR Real</h3>
    <p id="status-text">Inicializando...</p>
    <div id="debug" class="debug-info"></div>
    <button class="btn" onclick="window.location.href='index.html'">Volver</button>
  </div>

  <!-- Loading -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Inicializando AR 3D...</p>
  </div>

  <!-- Panel de permisos -->
  <div id="permission-panel" class="permission-panel" style="display: none;">
    <h2>Permisos Requeridos</h2>
    <p>Para que el AR funcione correctamente, necesitamos:</p>
    <ul style="text-align: left; margin: 20px 0;">
      <li>üìç Ubicaci√≥n GPS</li>
      <li>üì∑ C√°mara trasera</li>
      <li>üß≠ Sensores de movimiento</li>
    </ul>
    <button class="btn" id="grant-permissions-btn">Otorgar Permisos</button>
    <p id="permission-error" style="color: #ff6b6b; margin-top: 15px; display: none;"></p>
  </div>

  <script>
    class RealAR {
      constructor() {
        // Three.js variables
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.controls = null;
        
        // Elementos 3D
        this.arrow = null;
        this.targetMarker = null;
        
        // Datos de navegaci√≥n
        this.destino = null;
        this.userPosition = null;
        this.watchId = null;
        
        // Orientaci√≥n
        this.deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
        this.currentHeading = 0;
        this.targetBearing = 0;
        this.currentDistance = 0;
        
        // Elementos DOM
        this.infoDiv = null;
        this.debugDiv = null;
        this.statusText = null;
        
        this.init();
      }

      async init() {
        try {
          console.log('üöÄ Iniciando AR Real...');
          
          await this.cargarDestino();
          this.configurarElementosDOM();
          
          // Solicitar permisos
          await this.solicitarPermisos();
          
          // Inicializar Three.js
          this.inicializarThreeJS();
          
          // Iniciar sistemas
          await this.iniciarCamara();
          this.iniciarGPS();
          this.iniciarOrientacion();
          
          // Iniciar render loop
          this.animate();
          
          document.getElementById('loading').style.display = 'none';
          
        } catch (error) {
          console.error('‚ùå Error:', error);
          this.mostrarError('Error: ' + error.message);
        }
      }

      async solicitarPermisos() {
        return new Promise(async (resolve, reject) => {
          try {
            // Solicitar permisos de c√°mara
            const stream = await navigator.mediaDevices.getUserMedia({ 
              video: { facingMode: 'environment' },
              audio: false 
            });
            
            // Detener stream temporal (se usar√° en el video)
            stream.getTracks().forEach(track => track.stop());
            
            // Solicitar permisos de orientaci√≥n (especialmente para iOS)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
              const permission = await DeviceOrientationEvent.requestPermission();
              if (permission !== 'granted') {
                throw new Error('Permisos de orientaci√≥n denegados');
              }
            }
            
            resolve();
            
          } catch (error) {
            this.mostrarPanelPermisos(error.message);
            reject(error);
          }
        });
      }

      mostrarPanelPermisos(mensajeError = '') {
        document.getElementById('loading').style.display = 'none';
        const panel = document.getElementById('permission-panel');
        const errorElem = document.getElementById('permission-error');
        
        if (mensajeError) {
          errorElem.textContent = mensajeError;
          errorElem.style.display = 'block';
        }
        
        panel.style.display = 'flex';
        
        document.getElementById('grant-permissions-btn').onclick = async () => {
          try {
            await this.solicitarPermisos();
            panel.style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
          } catch (error) {
            errorElem.textContent = 'Error: ' + error.message;
            errorElem.style.display = 'block';
          }
        };
      }

      cargarDestino() {
        return new Promise((resolve, reject) => {
          try {
            const destinoData = localStorage.getItem('ar-destino');
            if (!destinoData) {
              reject(new Error('No se encontr√≥ destino seleccionado'));
              return;
            }
            
            this.destino = JSON.parse(destinoData);
            console.log('üéØ Destino:', this.destino);
            this.actualizarEstado(`üéØ <b>${this.destino.Nombre}</b><br>Iniciando AR 3D...`);
            resolve();
            
          } catch (error) {
            reject(new Error('Error cargando destino: ' + error.message));
          }
        });
      }

      configurarElementosDOM() {
        this.infoDiv = document.getElementById('info');
        this.debugDiv = document.getElementById('debug');
        this.statusText = document.getElementById('status-text');
      }

      inicializarThreeJS() {
        // Configurar escena
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.Fog(0x000000, 1, 1000);

        // Configurar c√°mara
        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        this.camera.position.set(0, 1.6, 0); // Altura de ojos

        // Configurar renderer
        this.renderer = new THREE.WebGLRenderer({ 
          alpha: true, 
          antialias: true 
        });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setClearColor(0x000000, 0); // Transparente
        this.renderer.domElement.style.position = 'fixed';
        this.renderer.domElement.style.top = '0';
        this.renderer.domElement.style.left = '0';
        this.renderer.domElement.style.zIndex = '2';
        
        document.getElementById('threejs-container').appendChild(this.renderer.domElement);

        // Configurar controles de orientaci√≥n del dispositivo
        this.controls = new THREE.DeviceOrientationControls(this.camera);
        
        // Crear flecha 3D
        this.crearFlecha3D();
        
        // Configurar luces
        this.configurarLuces();
        
        // Manejar redimensionado
        window.addEventListener('resize', this.onWindowResize.bind(this));
      }

      crearFlecha3D() {
        // Geometr√≠a de flecha m√°s elaborada
        const arrowGroup = new THREE.Group();

        // Cuerpo de la flecha (cono)
        const coneGeometry = new THREE.ConeGeometry(0.1, 0.8, 8);
        const coneMaterial = new THREE.MeshPhongMaterial({ 
          color: 0x4CAF50,
          transparent: true,
          opacity: 0.9
        });
        const cone = new THREE.Mesh(coneGeometry, coneMaterial);
        cone.position.y = 0.4; // Mitad de la altura
        cone.rotation.x = Math.PI; // Apuntar hacia adelante

        // Base de la flecha (cilindro)
        const cylinderGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.3, 8);
        const cylinderMaterial = new THREE.MeshPhongMaterial({ 
          color: 0x3366FF 
        });
        const cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
        cylinder.position.y = -0.15; // Debajo del cono

        // A√±adir al grupo
        arrowGroup.add(cone);
        arrowGroup.add(cylinder);

        // Posicionar la flecha frente a la c√°mara
        arrowGroup.position.set(0, 0, -3); // 3 metros adelante
        arrowGroup.visible = false;

        this.arrow = arrowGroup;
        this.scene.add(this.arrow);

        console.log('‚úÖ Flecha 3D creada');
      }

      configurarLuces() {
        // Luz ambiental
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        this.scene.add(ambientLight);

        // Luz direccional
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 5);
        this.scene.add(directionalLight);
      }

      async iniciarCamara() {
        try {
          console.log('üì∑ Iniciando c√°mara...');
          
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: {
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            },
            audio: false
          });
          
          const video = document.getElementById('camera-video');
          video.srcObject = stream;
          
          await new Promise((resolve) => {
            video.onloadedmetadata = () => {
              video.play();
              resolve();
            };
          });
          
          console.log('‚úÖ C√°mara iniciada correctamente');
          
        } catch (error) {
          console.error('‚ùå Error de c√°mara:', error);
          throw new Error(this.getCameraErrorMessage(error));
        }
      }

      getCameraErrorMessage(error) {
        switch(error.name) {
          case 'NotAllowedError':
            return 'Permiso de c√°mara denegado.';
          case 'NotFoundError':
            return 'No se encontr√≥ c√°mara trasera.';
          default:
            return 'Error de c√°mara: ' + error.message;
        }
      }

      iniciarGPS() {
        if (!navigator.geolocation) {
          this.mostrarError('Geolocalizaci√≥n no soportada');
          return;
        }

        console.log('üåç Iniciando GPS...');
        
        this.watchId = navigator.geolocation.watchPosition(
          (position) => this.actualizarPosicionUsuario(position),
          (error) => this.manejarErrorGPS(error),
          {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 5000
          }
        );
      }

      iniciarOrientacion() {
        if (typeof DeviceOrientationEvent === 'undefined') {
          this.mostrarError('Orientaci√≥n del dispositivo no soportada');
          return;
        }

        window.addEventListener('deviceorientation', (event) => {
          this.deviceOrientation = {
            alpha: event.alpha || 0,
            beta: event.beta || 0,
            gamma: event.gamma || 0
          };
          
          // Calcular heading basado en alpha (br√∫jula)
          if (event.alpha !== null) {
            this.currentHeading = event.alpha;
          }
        });

        console.log('üß≠ Sensores de orientaci√≥n iniciados');
      }

      actualizarPosicionUsuario(position) {
        this.userPosition = position;
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        const accuracy = position.coords.accuracy;
        
        this.currentDistance = this.calcularDistancia(userLat, userLon, this.destino.Latitud, this.destino.Longitud);
        this.targetBearing = this.calcularRumbo(userLat, userLon, this.destino.Latitud, this.destino.Longitud);
        
        this.actualizarInterfaz(this.currentDistance, this.targetBearing, accuracy);
        this.actualizarFlecha3D();
        
        if (this.currentDistance < 10) {
          this.llegadaDestino();
        }
      }

      calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                 Math.cos(œÜ1) * Math.cos(œÜ2) *
                 Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c;
      }

      calcularRumbo(lat1, lon1, lat2, lon2) {
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

        const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
        const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                 Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
        const Œ∏ = Math.atan2(y, x);

        return (Œ∏ * 180 / Math.PI + 360) % 360;
      }

      actualizarInterfaz(distancia, rumbo, accuracy) {
        let distanciaTexto;
        if (distancia < 1000) {
          distanciaTexto = `${Math.round(distancia)} m`;
        } else {
          distanciaTexto = `${(distancia/1000).toFixed(1)} km`;
        }

        this.actualizarEstado(`
          <b>${this.destino.Nombre}</b><br>
          üìè ${distanciaTexto} ¬∑ üß≠ ${Math.round(rumbo)}¬∞<br>
          <small>Precisi√≥n: ¬±${Math.round(accuracy)}m</small>
        `);
        
        // Debug info
        if (this.debugDiv) {
          this.debugDiv.innerHTML = `
            Usuario: ${this.userPosition.coords.latitude.toFixed(6)}, ${this.userPosition.coords.longitude.toFixed(6)}<br>
            Destino: ${this.destino.Latitud.toFixed(6)}, ${this.destino.Longitud.toFixed(6)}<br>
            Distancia: ${Math.round(distancia)}m | Rumbo: ${Math.round(rumbo)}¬∞<br>
            Heading: ${Math.round(this.currentHeading)}¬∞
          `;
        }
      }

      actualizarFlecha3D() {
        if (!this.arrow || this.targetBearing === undefined || this.currentHeading === undefined) {
          return;
        }

        // Calcular rotaci√≥n relativa
        let relativeBearing = this.targetBearing - this.currentHeading;
        
        // Ajustar para rango [-180, 180]
        if (relativeBearing > 180) relativeBearing -= 360;
        if (relativeBearing < -180) relativeBearing += 360;
        
        // Convertir a radianes y rotar flecha
        const rotationY = THREE.MathUtils.degToRad(relativeBearing);
        this.arrow.rotation.y = rotationY;
        
        // Hacer visible
        this.arrow.visible = true;
        
        // Cambiar color basado en alineaci√≥n
        this.actualizarColorFlecha(Math.abs(relativeBearing));
      }

      actualizarColorFlecha(angleDiff) {
        if (!this.arrow) return;
        
        const cone = this.arrow.children[0];
        const cylinder = this.arrow.children[1];
        
        let color;
        if (angleDiff < 10) {
          color = 0x4CAF50; // Verde
        } else if (angleDiff < 30) {
          color = 0xFF9800; // Naranja
        } else {
          color = 0xF44336; // Rojo
        }
        
        cone.material.color.setHex(color);
        cylinder.material.color.setHex(color);
      }

      animate() {
        requestAnimationFrame(this.animate.bind(this));
        
        // Actualizar controles de orientaci√≥n
        if (this.controls) {
          this.controls.update();
        }
        
        // Renderizar escena
        if (this.renderer && this.scene && this.camera) {
          this.renderer.render(this.scene, this.camera);
        }
      }

      onWindowResize() {
        if (this.camera && this.renderer) {
          this.camera.aspect = window.innerWidth / window.innerHeight;
          this.camera.updateProjectionMatrix();
          this.renderer.setSize(window.innerWidth, window.innerHeight);
        }
      }

      llegadaDestino() {
        this.actualizarEstado(`
          <div style="color: #4CAF50; font-weight: bold;">
            üéâ ¬°HAS LLEGADO!<br>
            ${this.destino.Nombre}
          </div>
        `);
        
        if (this.arrow) {
          this.arrow.visible = false;
        }
        
        if (this.watchId) {
          navigator.geolocation.clearWatch(this.watchId);
          this.watchId = null;
        }
        
        // Vibraci√≥n
        if (navigator.vibrate) {
          navigator.vibrate([300, 100, 300, 100, 300]);
        }
      }

      actualizarEstado(mensaje) {
        if (this.statusText) {
          this.statusText.innerHTML = mensaje;
        }
      }

      manejarErrorGPS(error) {
        let mensaje = 'Error GPS: ';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            mensaje = 'Permiso de ubicaci√≥n denegado. Activa la ubicaci√≥n.';
            break;
          case error.POSITION_UNAVAILABLE:
            mensaje = 'Ubicaci√≥n no disponible. Verifica tu GPS.';
            break;
          case error.TIMEOUT:
            mensaje = 'Tiempo de espera agotado.';
            break;
          default:
            mensaje = 'Error de GPS: ' + error.message;
        }
        this.mostrarError(mensaje);
      }

      mostrarError(mensaje) {
        console.error('‚ùå Error:', mensaje);
        this.actualizarEstado(`<div style="color: #ff4444;">${mensaje}</div>`);
      }

      cleanup() {
        if (this.watchId) {
          navigator.geolocation.clearWatch(this.watchId);
        }
        if (this.renderer) {
          this.renderer.dispose();
        }
        const video = document.getElementById('camera-video');
        if (video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
        }
      }
    }

    // Inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Iniciando AR Real...');
      window.realAR = new RealAR();
    });

    // Cleanup al salir
    window.addEventListener('beforeunload', () => {
      if (window.realAR) {
        window.realAR.cleanup();
      }
    });
  </script>
</body>
</html>